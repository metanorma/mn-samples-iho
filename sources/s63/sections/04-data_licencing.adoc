
[[data_licencing]]
== Data Licencing

[[data_licencing_introduction]]
=== Introduction

Data Clients do not buy ENC data but are licenced to use it. Licensing is the method that Data Servers use to give Data Clients selective access to up-to-date ENC cells for a given period of time.

To operate the scheme effectively there must be a means where Data Client systems can unlock the encrypted ENC cells. To unlock the data the Data Clients system must have access to the cell keys that were used to encrypt the ENC cells. These keys are supplied to the Data Client, encrypted, in a permit file containing a set of cell permits. It is these cell permits that contain the encryption keys.

To make each set of cell permits exclusive the cell keys must be encrypted using something that is unique to the Data Clients system. OEMs assign a unique identifier (HW_ID) to each of their systems and provide an encrypted copy of this, in the form of a userpermit, to each Data Client. The HW_ID is stored in the userpermit encrypted.

OEMs encrypt the HW_ID with their own unique manufacturer key (M_KEY) so that a HW_ID cannot be duplicated by another manufacturer. Data Servers have access to the OEM M_KEYs and can therefore decrypt the HW_ID stored in the userpermit. Data Servers encrypt their cell keys with the manufacturers HW_ID when producing a set of cell permits. This makes them unique to the Data Client and as such not transferable between Data Client systems.

[[fig2]]
.High Level ENC Licencing Diagram
image::image-02.png["","",""]

[[the_userpermit]]
=== The Userpermit

The userpermit is created by OEMs and supplied to Data Clients as part of their system so that they can obtain the necessary access to encrypted ENCs from Data Servers. The following section defines the composition and format of the userpermit.

All Data Clients with systems capable of using data, protected with the S-63 scheme, must have a unique hardware identification (HW_ID) built into their end-user system. Such a HW_ID is often implemented as a dongle or by other means ensuring a unique identification for each installation.

The HW_ID is unknown to the Data Client, but the OEM will provide a userpermit that is an encrypted version of the HW_ID and unique to the Data Client's system. The userpermit is created by taking the assigned HW_ID and encrypting it with the manufacturer key (M_KEY). The CRC32 algorithm is run on the encrypted HW_ID and the result appended to it. Finally the manufacturer attaches their assigned manufacturer identifier (M_ID) to the end of the resultant string. The M_KEY and M_ID values are supplied by the SA and are unique to each manufacturer providing S-63 compliant systems.

The Data Client gains access to S-63 encrypted ENCs by supplying this userpermit to the Data Server who can then issue Cell Permits specific to it. Since the userpermit contains the manufacturers unique M_ID this can be used by Data Servers to identify which M_KEY to use to decrypt it. The M_ID is the last four characters of the Userpermit. A list of the manufacturer M_KEY and M_ID values is issued and updated by the SA to all Data Servers subscribing to the scheme. This list will be updated periodically as new OEMs join the scheme.

[[definition_of_userpermit]]
==== Definition of Userpermit

The userpermit is 28 characters long and shall be written as ASCII text with the following mandatory format and field lengths:

[%unnumbered]
|===
h| Encrypted HW_ID h| Check Sum (CRC) h| M_ID (Manufacturer ID)
| 16 hex characters | 8 hex characters | 4 characters
3+|
3+| Any alphabetic character will be written in upper case. 
|===

[%unnumbered]
.Userpermit Structure
====
[%unnumbered]
image::image-03.png["","",""]
====

[[hw_id_format]]
==== HW_ID Format

The HW_ID is a 5 digit hexadecimal number defined by the OEM manufacturer. Such a HW_ID can be implemented as a dongle or by other means ensuring a unique identification of each installation {blank}footnote:[Manufactures, with the consent of the Data Server, may use the same HW_ID on more than one unit.]. The HW_ID must be stored within the system in a secure way.

The OEM manufacturer must assign a unique HW_ID for each installation. It is recommended that the HW_IDs are not sequential.

The HW_ID will be stored in an encrypted form in the Userpermit. It is encrypted using the Blowfish algorithm with M_KEY as the key resulting in a 16 digit (8 bytes) hexadecimal number. The encrypted HW_ID is then represented in its ASCII form in the userpermit as 16 characters.

Example of HW_ID is: *`A79AB`* +
Example of encrypted HW_ID is: *`73871727080876A0`*

[[crc_format]]
==== Check Sum (CRC) Format

The Check Sum is an 8 character hexadecimal number. It is generated by taking the encrypted HW_ID and converting it to a 16 character hexadecimal string. It is then hashed using the algorithm CRC32 <<crc32>> and the 4 bytes converted to an 8 character hexadecimal string.

The Check Sum is not encrypted and allows the integrity of the Userpermit to be checked.

The Check Sum in the above example is: *`7E450C04`*

[[m_id_format]]
==== M_ID Format

The M_ID is a 2-character alphanumeric code expressed as ASCII representation provided by the SA. The SA will provide all licenced manufacturers with their own unique Manufacturer Key and Identifier (M_KEY and M_ID) combination. The manufacturer must safeguard this information.

The SA will provide all licenced Data Servers with a full listing of all manufacturer codes as and when new manufacturers subscribe to the scheme. This information is used by the Data Server to determine which key (M_KEY) to use to decrypt the HW_ID in the Userpermit during the creation of Data Client cell permits.

The M_ID in the above example is: *`01`* or *`3031 (ASCII`* {blank}footnote:[NOTE: The hex encoding may be unfamiliar to some readers. For historical reasons it has been preserved in this version of the standard. “1 2 3 4 5” is translated into “31 32 33 34 35” because the ASCII Base 16 representation of the character “1” is “31” etc. Though confusing at first this convention is used throughout the standard consistently as is standard hexadecimal and binary representations. To differentiate it is referred to as “(ASCII)”] *`)`*

[[m_key_format]]
==== M_KEY Format

The M_KEY is a 5 digit hexadecimal number provided by the SA. The OEM uses this key to encrypt assigned HW_ID when generating userpermits. The OEM must store it securely. This key is used by the Data Server to decrypt assigned HW_IDs.

Example of M_KEY is *`123AB`* or *`3132334142 (ASCII)`*

[[the_cell_permit]]
=== The Cell Permit

To decrypt an ENC cell the Data Client must have access to the encryption key (see <<how_is_it_encrypted>>) used to encrypt it. Since the encryption keys are only known to the Data Server there needs to be a means of delivering this information to Data Clients in a protected manner. This information is supplied by the Data Server (e.g. RENC or VAR)to the Data Client in an encrypted form known as a cell permit. A single file is provided to deliver the cell permit and is named PERMIT.TXT (see <<permit_txt>>). This file may contain several cell permits based on the ENC coverage required by the Data Client.

The PERMIT.TXT file will be delivered either on hard media or using online services in accordance with the Data Servers operating procedures. These procedures will be made available to Data Clients when purchasing a licence.

Each cell permit record also contains additional fields that are supplied to assist OEM systems to manage the Data Clients licence and permit files from multiple Data Servers, see <<permit_record_fields>>.

Data Clients can obtain a licence to access ENCs by supplying the Data Server with their unique userpermit (see <<the_userpermit>>). Data Servers can then extract the HW_ID from userpermit, using the Data Client's M_KEY, and create client specific cell permits based on this value. The format of a cell permit record is described below in <<permit_file_header_formats>> & <<permit_record_fields>>.

Since Cell Permits are issued for a specific HW_ID they are consequently not transferable between installations (Data Client Systems). This method of linking the permit to the installation supports the production of generically encrypted CDs which can be distributed to all Data Clients subscribing to a service.

The Data Clients system decrypts the Cell Permit using the assigned HW_ID stored securely by hardware or software means. The decrypted cell keys can then be used by the system to decrypt the ENC cell. Since several Data Servers can make permit files for ENCs in their service, it is the responsibility of the Data Client system to manage permit files from several Data Servers.

NOTE: *Data Servers* should continue to provide both types of permit files (ENC.PMT & PERMIT.TXT) as described in S-63 Edition 1.0. This should continue until such time that it can be determined that the omission of the ENC.PMT file will not compromise the safe use of older legacy systems. The timescale for this must be agreed between all stakeholders. *OEMs* must ensure that new implementations of their ECDIS software are able to merge permits from multiple data servers without losing permit information using only the PERMIT.TXT file.

[[permit_txt]]
==== The Permit File (PERMIT.TXT)

The Cell Permit will always be provided in a file called PERMIT.TXT, the filename will always provided in UPPERCASE as will any alphabetic characters contained in the file. The file is completely encoded in ASCII {blank}footnote:[OEMs should be aware that all ASCII text files generated by the scheme may contain ambiguous end-of-line markers such as CR or CRLF and should be able to deal with these.] and contains 3 sections as follows:

[%unnumbered]
|===
h| Section h| Description
| *Header* | This includes the file creation date and the format version.
| *:ENC* | ENC permits (official) from the Data Server are listed under this section.
| *:ECS* | ECS permits (non-official) from the Data server can be listed under this section.
|===

The Data Server will make available information regarding how the permit files will be made available whether on hard media or online services. The following table defines the content and format of each section within the permit files separated by "new lines [NL]".

[[permit_file_header_formats]]
==== The Permit File - Header Formats

The following table defines the content and format of each section header within the permit file.

[%unnumbered]
|===
h| Section h| Fieldname h| Value

| *Date and time* | *`:DATE`* a| The field name, date and time is separated by a space character (SP < h20 >). The date will be provided as *`YYYYMMDD`* and the time as *`HH:MM`* using the 24 hour clock. +
Example: *`:DATE 20050809 11:11`*

| *Meta Permit version* | *`:VERSION`* a| Integer in range 1 to 99. +
It will be incremented by 1 for each new version of the permit file format specification. S-63 Edition 1.1 defines the value as "2". +
i.e. *`:VERSION`* `2`

| *Cell Permit type* | *`:ENC`* | Field contains definition of permits available in an ENC distribution license from the Data Server. Field is identified with the following label in upper case *`:ENC`*

| *Cell Permit type* | *`:ECS`* | Field contains definition of the meta permits available in an ECS distribution license from the Data Server. Field is identified with the following label in upper case *`:ECS`*
|===

[%unnumbered] 
====
*`:DATE 20080809 11:11`* +
*`:VERSION 2`* +
*`:ENC`* +
`[List of licenced cell permits for official ENCs]` +
*`:ECS`* +
`[List of licence cell permits for other vector products]`
====

[[permit_record_fields]]
==== Permit Record Fields

The Cell Permit Record is comprised of the following comma separated fields:

[%unnumbered]
|===
h| Field h| Value
| *Cell Permit* | As defined in <<definition_of_the_cell_permit>> & <<cell_permit_format>>
| *Service Level Indicator* a| *`0`* for subscription permit +
*`1`* for single purchase permit
| *Edition Number [Optional]* | DSID-EDTN issue number of the ENC cell (for Data Servers use only)
| *Data Server ID* | This is a two character alphanumeric issued by the SA
| *Comment* | Free text field for comments on the cell permit etc.

|===

NOTE: The "Edition Number [Optional]" field is no longer a mandatory requirement in S-63, Edition 1.1. *_OEMs_* implementing edition 1.1 should no longer build any dependency into their systems that checks the relationship between the edition number of the ENC and cell key used to encrypt it. *_Data Clients_* should only check to see if there is a valid cell key in the permit string. *_Data Servers_* will continue to support edition 1.0 PERMIT.TXT files until such time as it can be determined that it is no longer required.

[[definition_of_the_cell_permit]]
==== Definition of the Cell Permit

The following table defines the fields contained in cell permit with a definition of the purpose of each.

[%unnumbered]
|===
h| Field h| Purpose
| *Cell Name:* | The cell name enables Data Client systems to link the correct encryption key to the corresponding encrypted ENC cell file.
| *Expiry Date:* | This is the date when the Data Clients licence expires. Systems must prevent any new ENC cells, new editions or updates created after this date from being installed.
| *Encrypted Cell Key 1 (ECK1)* | ECK1 contains the decryption key for the current version of the ENC Cell.
| *Encrypted Cell Key 2 (ECK2)* | ECK2 contains the decryption key to be used when the cell key is next iterated. The future key is contained within the cell permit to allow Data Servers to periodically change the Cell Key without simultaneously issuing new cell permits to all Data Clients.
| *Check Sum (CRC)* | This value is provided to protect against tampering or accidental corruption.

|===

[[cell_permit_format]]
==== Cell Permit Format

The Cell Permit shall be written as ASCII text with the following mandatory format and field lengths:

[%unnumbered]
|===
h| Field h| Characters h| Format

| *Cell Name* ^.^| 8 a| An alphanumeric string following the convention defined in S-57 Edition 3.1 Appendix B section 5.6 for cell names excluding the filename extension. +
Example is: *`NO4D0613`*

| *Expiry Date* ^.^| 8 a| A numeric string that contains the license expiry date for each ENC in the format *`YYYYMMDD`*. +
Example is: *`20000830`* (30^th^ August 2000)

| *ECK1 & ECK2* {blank}footnote:[The cell permit contains two fields for providing the data client system with the cell keys necessary to decrypt a specific ENC cell file. These fields may contain either two identical cell keys or two different cell keys and may differ between data servers. Some data servers may prefer to increment the cell keys only in the event of the security scheme is compromised others may prefer to periodically increment them according to their service procedures. The mechanism for data servers producing these keys is described in more detail in <<management_of_eck>>. OEMs should note that any dependency on the edition number should be removed from theirs systems in edition 1.1 of the scheme.] ^.^| 16 a| The Cell Keys are 5 byte random numbers – their hex representations are encrypted using Blowfish and then expressed in hexadecimal in the permit. +
NOTE: The blowfish encryption algorithm will cause the encrypted data to be padded to a multiple of 8 bytes in length. This means that encrypted Cell Keys are actually 8 bytes long, even though unencrypted they are only 5 bytes long (10 hex characters) +
Example: +
ECK1: *`BEB9BFE3C7C6CE68`* +
ECK2: *`B16411FD09F96982`*

| *ENC Permit Checksum* ^.^| 16 | Contains the encrypted check sum for the Cell Permit. It is encrypted using the Blowfish algorithm with the Data Client's specific HW_ID and is an 8 byte number. This check sum is encrypted as opposed to the unencrypted check sum of the User Permit. +
e.g. The ENC Check Sum in the example below is: *`795C77B204F54D48`*
|===

[%unnumbered]
.Cell Permit Field
====
[%unnumbered]
image::image-04.png["","",""]
====

[%unnumbered]
.Cell Permit Record
====
[%unnumbered]
image::image-05.png["","",""]
====

[[additional_licence_file]]
==== Additional Licence File (Optional)

Data Servers may wish to include an additional file, along with the PERMIT.TXT file, to identify the licencee and provide information relating to system ID {blank}footnote:[It may be useful when processing data client queries to have instant access to customer information such as licencing information and manufacturer ID. Data clients could supply this file with the query to speed up response times.]. This file will be named \****.LIC, where ** represents the data server ID.

Data client systems can access this file (if present) to display user information and provide userpermit information.

The file contains a single record with the following fields:

[%unnumbered]
|===
h| Field ID h| Characters h| Notes
| Licensee ^.^| 40 | Name of company or individual signing the licence.
| Vessel Name ^.^| 40 | Optional. This field may be left as spaces.
| Fixed Site #1 ^.^| 240 | Company Name and Address. This field contains free format text arranged in 6 x 40 byte sub-fields. Text will not cross the boundaries of the sub-fields.
| Host System Name ^.^| 40 | For instance, Main, Backup, etc.
| User Permit ^.^| 28 | Hexadecimal user permit
| Licence Type ^.^| 40 | Service Indicator, e.g. Primar Stavanger ENC Service
| HO data ^.^| 36 | Data for HO / Agent / Distributor use.
3+a| Total number of bytes: 464

|===